<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIM AI Âçè‰ΩúÂπ≥Âè∞ (VPN/Á®≥ÂÆöÁâà)</title>
    <style>
        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #222;
        }

        #three-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            outline: none;
        }

        /* ÈîôËØØÊèêÁ§∫ */
        #error-banner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #d32f2f;
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 100;
            display: none;
            font-weight: bold;
            font-family: monospace;
        }

        /* Â∑¶‰æßÊéßÂà∂Âå∫ */
        #controls-container {
            position: absolute;
            top: 60px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2;
            width: 300px;
        }

        /* Â§çÊ†∏Èù¢Êùø */
        #review-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 360px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 2;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #444;
        }

        #review-header {
            background: #0078d4;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #review-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* ÁªÑ‰ª∂Ê†∑Âºè */
        .progress-container {
            height: 6px;
            background: #444;
            width: 100%;
        }

        .progress-bar {
            height: 100%;
            background: #00ff88;
            width: 0%;
            transition: width 0.3s;
        }

        .ai-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .conf-high {
            background-color: #28a745;
        }

        .conf-low {
            background-color: #dc3545;
        }

        .field-label {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            display: block;
        }

        .field-value {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .reasoning-box {
            background: #f8f9fa;
            border-left: 3px solid #0078d4;
            padding: 10px;
            font-size: 13px;
            color: #555;
            margin: 10px 0;
            line-height: 1.4;
            font-style: italic;
        }

        select.category-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-confirm {
            background: #0078d4;
            color: white;
        }

        .btn-skip {
            background: #e0e0e0;
            color: #333;
        }

        /* Loading */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
            flex-direction: column;
            font-weight: bold;
            color: #333;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .file-group {
            margin-bottom: 15px;
        }

        .file-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>

    <!-- 1. Âû´ÁâáÔºöÂº∫Âà∂ÊµèËßàÂô®ÊîØÊåÅ Import Map -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <!-- 2. ÂÖ≥ÈîÆÔºö‰ΩøÁî®‰∏ÄÂ•óÂÆåÂÖ®ÂÖºÂÆπÁöÑÊóßÁâàÊú¨ (Three r148 + WebIFC 0.124) -->
    <!-- Êó¢ÁÑ∂‰Ω†Êúâ VPNÔºåÊàë‰ª¨‰ΩøÁî® unpkgÔºåËøôÊòØÊúÄÊ†áÂáÜÁöÑÊ∫ê -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.148.0/build/three.module.js",
                "three/examples/jsm/": "https://unpkg.com/three@0.148.0/examples/jsm/",
                "web-ifc": "https://unpkg.com/web-ifc@0.0.44/web-ifc-api.js",
                "web-ifc-three": "https://unpkg.com/web-ifc-three@0.0.124/IFCLoader.js"
            }
        }
    </script>
</head>

<body>
    <div id="error-banner"></div>

    <div id="controls-container">
        <h2 style="margin-top:0">üèóÔ∏è BIM AI Âçè‰ΩúÂπ≥Âè∞</h2>
        <div class="file-group">
            <label>Step 1: Âä†ËΩΩÊ®°Âûã (.ifc)</label>
            <input type="file" id="file-input" accept=".ifc">
        </div>
        <div class="file-group">
            <label>Step 2: Âä†ËΩΩ AI ÂàÜÊûêÊï∞ÊçÆ (.json)</label>
            <input type="file" id="json-input" accept=".json" disabled>
        </div>
        <div class="tips" style="font-size: 12px; color: #666; margin-top: 10px;">
            ÁâàÊú¨: Three.js r148 (Stable)<br>
            Á°Æ‰øù VPN Â∑≤ÂºÄÂêØ„ÄÇ
        </div>
    </div>

    <div id="review-panel">
        <div class="progress-container">
            <div class="progress-bar" id="review-progress-bar"></div>
        </div>
        <div id="review-header">
            <span id="review-counter">Â§çÊ†∏ËøõÂ∫¶: 0 / 0</span>
            <button onclick="exportResults()"
                style="background:none; border:1px solid #fff; color:fff; border-radius:4px; cursor:pointer; color: white;">ÂØºÂá∫
                JSON</button>
        </div>
        <div id="review-body">
            <div id="review-content">
                <div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ÂæÖÂ§çÊ†∏Êï∞ÊçÆ</div>
            </div>
            <div id="review-actions" style="display:none;">
                <label class="field-label">‰∫∫Â∑•Á°ÆËÆ§ÂàÜÁ±ª:</label>
                <select id="category-select" class="category-select"></select>
                <div class="action-buttons">
                    <button class="btn btn-skip" onclick="prevItem()">‰∏ä‰∏Ä‰∏™</button>
                    <button class="btn btn-confirm" onclick="confirmAndNext()">Á°ÆËÆ§Âπ∂‰∏ã‰∏Ä‰∏™</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Â§ÑÁêÜ‰∏≠...</div>
    </div>

    <canvas id="three-canvas"></canvas>

    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { IFCLoader } from 'web-ifc-three';
        import { IFCPRODUCT } from 'web-ifc';  // <--- Êñ∞Â¢ûËøô‰∏ÄË°å

        // ÈîôËØØÊçïËé∑
        window.onerror = function (msg) {
            console.error(msg);
            const banner = document.getElementById('error-banner');
            banner.style.display = 'block';
            banner.innerText = "‚ùå ËøêË°åÈîôËØØ: " + msg + " (ËØ∑ÊåâF12Êü•ÁúãConsole)";
            hideLoading();
        };

        let scene, camera, renderer, controls, ifcLoader;
        let ifcModel = null;
        let guidMap = new Map();
        let hitlData = null;
        let reviewQueue = [];
        let currentReviewIdx = -1;

        // È´ò‰∫ÆÊùêË¥®
        const highlightMaterial = new THREE.MeshLambertMaterial({
            transparent: true, opacity: 0.8, color: 0xff0055, depthTest: false
        });

        // --- 1. ÂàùÂßãÂåñÂú∫ÊôØ ---
        function initScene() {
            try {
                const canvas = document.getElementById('three-canvas');
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xe0e4e8);

                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 500);
                camera.position.set(20, 20, 20);

                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(10, 20, 10);
                scene.add(dirLight);

                const grid = new THREE.GridHelper(100, 100, 0x999999, 0xcccccc);
                scene.add(grid);
                const axes = new THREE.AxesHelper(5);
                scene.add(axes);

                controls = new OrbitControls(camera, canvas);
                controls.enableDamping = true;

                console.log("‚úÖ 3D ÂºïÊìéÂàùÂßãÂåñÊàêÂäü");
            } catch (e) {
                alert("Three.js ÂàùÂßãÂåñÂ§±Ë¥•: " + e.message);
            }
        }

        initScene();
        animate();

        // --- 2. ÈÖçÁΩÆ IFC Loader ---
        ifcLoader = new IFCLoader();

        // ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÂ§çÔºöWASM Ë∑ØÂæÑ ‚òÖ‚òÖ‚òÖ
        // ËøôÈáåÁöÑË∑ØÂæÑÂøÖÈ°ª‰ª• '/' ÁªìÂ∞æÔºå‰∏îËØ•Ë∑ØÂæÑ‰∏ãÂøÖÈ°ªËÉΩËÆøÈóÆÂà∞ web-ifc.wasm
        // ÁâàÊú¨ 0.0.44 ÁöÑ wasm Êñá‰ª∂Âú® unpkg ÁöÑÊ†πÁõÆÂΩï‰∏ã
        ifcLoader.ifcManager.setWasmPath('https://unpkg.com/web-ifc@0.0.44/');

        const fileInput = document.getElementById('file-input');
        const jsonInput = document.getElementById('json-input');

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoading("Ê≠£Âú®‰∏ãËΩΩ WASM ÂºïÊìéÂπ∂Ëß£Êûê (ËØ∑Á®çÂÄô)...");

            const url = URL.createObjectURL(file);

            ifcLoader.load(url,
                (model) => {
                    ifcModel = model;
                    scene.add(model);

                    if (model.geometry.boundingBox) {
                        const center = model.geometry.boundingBox.getCenter(new THREE.Vector3());
                        controls.target.copy(center);
                        camera.position.set(center.x + 30, center.y + 30, center.z + 30);
                    }

                    showLoading("Ê≠£Âú®Âª∫Á´ã GUID Á¥¢Âºï...");
                    setTimeout(async () => {
                        await buildGuidMap(model.modelID);
                        hideLoading();
                        jsonInput.disabled = false;
                        alert("‚úÖ Ê®°ÂûãÂä†ËΩΩÊàêÂäüÔºÅ\nËØ∑ÁªßÁª≠ÈÄâÊã© .json Êñá‰ª∂„ÄÇ");
                    }, 100);
                },
                (progress) => {
                    // console.log(progress);
                },
                (error) => {
                    console.error(error);
                    hideLoading();
                    const banner = document.getElementById('error-banner');
                    banner.style.display = 'block';
                    banner.innerText = "‚ùå Ëß£ÊûêÂ§±Ë¥•ÔºÅÂèØËÉΩÊòØ WASM Êñá‰ª∂Âä†ËΩΩË∂ÖÊó∂ (404/Timeout)„ÄÇËØ∑Ê£ÄÊü• VPN„ÄÇ";
                }
            );
        });

        // // --- 3. Âª∫Á´ãÁ¥¢Âºï (ÈíàÂØπ Python GUID) ---
        // async function buildGuidMap(modelID) {
        //     guidMap.clear();
        //     try {
        //         // Â¶ÇÊûúÊ®°ÂûãÂæàÂ§ßÔºågetAllItems ÂèØËÉΩ‰ºöÊÖ¢
        //         const lines = await ifcLoader.ifcManager.getAllItems(modelID, 0, true);
        //         for (const line of lines) {
        //             if (line.GlobalId && line.GlobalId.value) {
        //                 guidMap.set(line.GlobalId.value, line.expressID);
        //             }
        //         }
        //         console.log(`Á¥¢ÂºïÂª∫Á´ãÂÆåÊàê: ${guidMap.size} ‰∏™ÊûÑ‰ª∂`);
        //     } catch (e) {
        //         console.error("Á¥¢ÂºïÂ§±Ë¥•", e);
        //     }
        // }
        // // --- 3. Âª∫Á´ãÁ¥¢Âºï (ÈíàÂØπ Python GUID) ---
        // async function buildGuidMap(modelID) {
        //     guidMap.clear();
        //     console.log("ÂºÄÂßãÂª∫Á´ã GUID Á¥¢Âºï...");

        //     try {
        //         // Ëé∑ÂèñÊâÄÊúâ IFC ÊûÑ‰ª∂Ë°å
        //         // Ê≥®ÊÑèÔºöÂ¶ÇÊûú‰Ω†Âè™ÊÉ≥Á¥¢ÂºïÊúâÂá†‰Ωï‰ΩìÁöÑÊûÑ‰ª∂ÔºåÊïàÁéáÊõ¥È´òÁöÑÊñπÊ≥ïÊòØÂè™Ëé∑Âèñ IFCPRODUCT Á±ªÂûã
        //         // ‰ΩÜ‰∏∫‰∫Ü‰øùÈô©Ëµ∑ËßÅÔºåÊàë‰ª¨ÂÖà‰øùÊåÅËé∑ÂèñÊâÄÊúâÈ°πÁõÆÔºåÂπ∂Âú®Âæ™ÁéØ‰∏≠Á≠õÈÄâ
        //         const lines = await ifcLoader.ifcManager.getAllItems(modelID, 0, true);

        //         let validCount = 0;
        //         let debugLogged = false;

        //         for (const line of lines) {
        //             // 1. Ëé∑Âèñ GlobalIdÔºåÂÖºÂÆπÂØπË±°ÂÜôÊ≥ïÂíåÂ≠óÁ¨¶‰∏≤Áõ¥Êé•ÂÜôÊ≥ï
        //             let rawGuid = null;

        //             if (line.GlobalId) {
        //                 if (typeof line.GlobalId === 'string') {
        //                     rawGuid = line.GlobalId;
        //                 } else if (line.GlobalId.value) {
        //                     rawGuid = line.GlobalId.value;
        //                 }
        //             }

        //             // 2. Â¶ÇÊûúÂ≠òÂú® GUIDÔºåÂàôÂ≠òÂÖ• Map
        //             if (rawGuid) {
        //                 // Python ÁîüÊàêÁöÑ JSON ÈáåÁöÑ GUID ‰πüÊòØ 22 ‰ΩçÂéãÁº©Ê†ºÂºèÔºåÁõ¥Êé•ÂåπÈÖçÂç≥ÂèØ
        //                 guidMap.set(rawGuid, line.expressID);
        //                 validCount++;

        //                 // ÊâìÂç∞ÂâçÂá†‰∏™ GUID Áî®‰∫éË∞ÉËØïÔºåÁ°Æ‰øùÊ†ºÂºèÁúãËµ∑Êù•Âíå JSON ‰∏ÄÊ†∑
        //                 if (!debugLogged) {
        //                     console.log("üîç [Ë∞ÉËØï] Ê®°Âûã‰∏≠ËØªÂèñÂà∞ÁöÑÁ¨¨‰∏Ä‰∏™ GUID:", rawGuid);
        //                     console.log("üîç [Ë∞ÉËØï] ÂØπÂ∫îÁöÑ ExpressID:", line.expressID);
        //                     debugLogged = true;
        //                 }
        //             }
        //         }

        //         console.log(`‚úÖ Á¥¢ÂºïÂª∫Á´ãÂÆåÊàê: ÊàêÂäüÁ¥¢Âºï ${guidMap.size} / ${lines.length} ‰∏™ÊûÑ‰ª∂`);

        //         if (guidMap.size === 0) {
        //             console.error("‚ùå Ë≠¶Âëä: GUID Map ‰∏∫Á©∫ÔºÅËØ∑Ê£ÄÊü• Console ‰∏≠ line ÂØπË±°ÁöÑÁªìÊûÑ„ÄÇ");
        //             // ÊâìÂç∞‰∏ÄË°åÂéüÂßãÊï∞ÊçÆÁúãÁúãÁªìÊûÑ
        //             if (lines.length > 0) console.log("üîç Á¨¨‰∏ÄË°åÂéüÂßãÊï∞ÊçÆ:", lines[0]);
        //         }

        //     } catch (e) {
        //         console.error("‚ùå Á¥¢ÂºïÂª∫Á´ãÂ§±Ë¥•", e);
        //         alert("Á¥¢ÂºïÂª∫Á´ãÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÁªÜÈîôËØØ„ÄÇ");
        //     }
        // }
        // --- 3. Âª∫Á´ãÁ¥¢Âºï (‰øÆÂ§çÁâàÔºö‰ΩøÁî® getAllItemsOfType) ---
        async function buildGuidMap(modelID) {
            guidMap.clear();
            console.log(`üöÄ ÂºÄÂßãÂª∫Á´ãÁ¥¢Âºï (Model ID: ${modelID})...`);

            try {
                // ‰ΩøÁî® getAllItemsOfType Ëé∑ÂèñÊâÄÊúâ "‰∫ßÂìÅÁ∫ß" ÊûÑ‰ª∂ (Â¢ô„ÄÅÊ¢Å„ÄÅÊùøÁ≠â)
                // Á¨¨‰∏â‰∏™ÂèÇÊï∞ true Ë°®Á§∫Áõ¥Êé•ËøîÂõûÂ±ûÊÄßÊï∞ÊçÆÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØ ID
                const lines = await ifcLoader.ifcManager.getAllItemsOfType(modelID, IFCPRODUCT, true);

                console.log(`üìä ÊâæÂà∞ ${lines.length} ‰∏™ÊûÑ‰ª∂ÔºåÊ≠£Âú®Ëß£Êûê GUID...`);

                let successCount = 0;

                for (const line of lines) {
                    // ÂÆâÂÖ®ÊèêÂèñ GUID
                    let rawGuid = null;
                    if (line.GlobalId) {
                        if (line.GlobalId.value) {
                            rawGuid = line.GlobalId.value;
                        } else if (typeof line.GlobalId === 'string') {
                            rawGuid = line.GlobalId;
                        }
                    }

                    if (rawGuid) {
                        guidMap.set(rawGuid, line.expressID);
                        successCount++;
                    }
                }

                console.log(`‚úÖ Á¥¢ÂºïÂª∫Á´ãÂÆåÊàêÔºÅÊúâÊïàÊûÑ‰ª∂Êï∞: ${successCount}`);

                if (successCount === 0) {
                    console.warn("‚ö†Ô∏è Ë≠¶Âëä: Êú™ÊâæÂà∞‰ªª‰ΩïÂ∏¶Êúâ GUID ÁöÑÊûÑ‰ª∂„ÄÇ");
                }

            } catch (e) {
                console.error("‚ùå Á¥¢ÂºïÂª∫Á´ãÂ§±Ë¥•", e);
                const banner = document.getElementById('error-banner');
                banner.style.display = 'block';
                banner.innerText = "‚ùå Á¥¢ÂºïÈîôËØØ: " + e.message;
            }
        }
        // // --- 3. Âª∫Á´ãÁ¥¢Âºï (Âº∫Â£ÆÁâà) ---
        // async function buildGuidMap(modelID) {
        //     guidMap.clear();
        //     console.log(`üöÄ ÂºÄÂßãÂª∫Á´ãÁ¥¢Âºï (Model ID: ${modelID})...`);

        //     try {
        //         // 1. Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆË°å
        //         // Ê≥®ÊÑèÔºögetAllItems ‰ºöËøîÂõûÊ®°ÂûãÈáåÁöÑ‰∏ÄÂàáÔºåÂåÖÊã¨ÁÇπ„ÄÅÁ∫ø„ÄÅÈ¢úËâ≤Á≠â
        //         const lines = await ifcLoader.ifcManager.getAllItems(modelID);

        //         if (!lines || lines.length === 0) {
        //             throw new Error("Ê®°ÂûãÊï∞ÊçÆ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂª∫Á´ãÁ¥¢Âºï");
        //         }

        //         console.log(`üìä Ê®°ÂûãÂåÖÂê´ ${lines.length} Êù°Êï∞ÊçÆÔºåÊ≠£Âú®Á≠õÈÄâÊûÑ‰ª∂...`);

        //         let successCount = 0;

        //         for (const line of lines) {
        //             // --- ÂÆâÂÖ®Ê£ÄÊü•ÂºÄÂßã ---

        //             // 1. Â¶ÇÊûúËøôË°åÊï∞ÊçÆÊòØÁ©∫ÁöÑÔºåË∑≥Ëøá
        //             if (!line) continue;

        //             // 2. Â∞ùËØïÊèêÂèñ GlobalId
        //             let rawGuid = null;

        //             try {
        //                 // ÊÉÖÂÜµ A: GlobalId ÊòØÂØπË±° { type: 251, value: "..." }
        //                 if (line.GlobalId && line.GlobalId.value) {
        //                     rawGuid = line.GlobalId.value;
        //                 }
        //                 // ÊÉÖÂÜµ B: GlobalId Áõ¥Êé•ÊòØÂ≠óÁ¨¶‰∏≤ "..."
        //                 else if (typeof line.GlobalId === 'string') {
        //                     rawGuid = line.GlobalId;
        //                 }
        //                 // ÊÉÖÂÜµ C: Êúâ‰∫õÊï∞ÊçÆÂèØËÉΩÊ†πÊú¨Ê≤°Êúâ GlobalId (ÊØîÂ¶Ç IfcCartesianPoint)ÔºåËøôÊòØÊ≠£Â∏∏ÁöÑÔºåÁõ¥Êé•ÂøΩÁï•
        //             } catch (err) {
        //                 // Â¶ÇÊûúÊèêÂèñËøáÁ®ãÂá∫ÈîôÔºå‰∏ç‰∏≠Êñ≠Âæ™ÁéØÔºå‰ªÖË∑≥ËøáÊ≠§Êù°
        //                 continue;
        //             }

        //             // --- ÂÆâÂÖ®Ê£ÄÊü•ÁªìÊùü ---

        //             // 3. Â¶ÇÊûúÊàêÂäüÊèêÂèñÂà∞‰∫Ü GUIDÔºåÂ≠òÂÖ• Map
        //             if (rawGuid) {
        //                 guidMap.set(rawGuid, line.expressID);
        //                 successCount++;
        //             }
        //         }

        //         console.log(`‚úÖ Á¥¢ÂºïÂª∫Á´ãÂÆåÊàêÔºÅÊúâÊïàÊûÑ‰ª∂Êï∞: ${successCount}`);

        //         // Âè™ÊúâÂΩìÊúâÊïàÊûÑ‰ª∂‰∏∫0Êó∂ÊâçÊä•Èîô
        //         if (successCount === 0) {
        //             console.warn("‚ö†Ô∏è Ë≠¶Âëä: Âç≥‰ΩøÂª∫Á´ã‰∫ÜÁ¥¢ÂºïÔºå‰ΩÜÊï∞Èáè‰∏∫ 0„ÄÇËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞ÈáåÊâìÂç∞ÁöÑÁ¨¨‰∏ÄÊù° line Êï∞ÊçÆÁªìÊûÑ„ÄÇ");
        //             if (lines.length > 0) console.log("üîç Ë∞ÉËØï - Á¨¨‰∏ÄÊù°Êï∞ÊçÆ:", lines[0]);
        //         }

        //     } catch (e) {
        //         console.error("‚ùå ‰∏•ÈáçÈîôËØØ: Á¥¢ÂºïËøáÁ®ãÂ¥©Ê∫É", e);
        //         const banner = document.getElementById('error-banner');
        //         banner.style.display = 'block';
        //         banner.innerText = "‚ùå Á¥¢ÂºïÂ§±Ë¥•: " + e.message;
        //     }
        // }

        // --- 4. ‰∫§‰∫íÈÄªËæë ---
        jsonInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    hitlData = JSON.parse(e.target.result);
                    initReviewProcess();
                } catch (err) { alert("JSON Ê†ºÂºèÈîôËØØ: " + err); }
            };
            reader.readAsText(file);
        });

        function initReviewProcess() {
            const categories = hitlData.meta.all_categories || [];
            const select = document.getElementById('category-select');
            select.innerHTML = "";
            categories.sort().forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.text = cat;
                select.appendChild(opt);
            });

            reviewQueue = [];
            const results = hitlData.results || [];
            results.forEach(item => {
                if (item.status === "NEEDS_REVIEW") {
                    const eid = guidMap.get(item.guid);
                    if (eid) {
                        item.expressID = eid;
                        reviewQueue.push(item);
                    }
                }
            });

            if (reviewQueue.length === 0) {
                alert("Ê≤°ÊúâÊ£ÄÊµãÂà∞ÈúÄË¶ÅÂ§çÊ†∏ÁöÑÊûÑ‰ª∂ÔºÅ");
            } else {
                document.getElementById('review-panel').style.display = 'flex';
                currentReviewIdx = 0;
                loadReviewItem(0);
            }
        }

        window.loadReviewItem = function (index) {
            if (index < 0 || index >= reviewQueue.length) return;
            const item = reviewQueue[index];

            const progress = ((index + 1) / reviewQueue.length) * 100;
            document.getElementById('review-progress-bar').style.width = `${progress}%`;
            document.getElementById('review-counter').innerText = `${index + 1} / ${reviewQueue.length}`;

            const confClass = item.confidence > 0.5 ? 'conf-high' : 'conf-low';
            document.getElementById('review-content').innerHTML = `
                <div class="field-label">ÊûÑ‰ª∂ÂêçÁß∞</div><div class="field-value">${item.name || 'Unnamed'}</div>
                <div class="field-label">AI Âª∫ËÆÆ</div>
                <div class="field-value"><span class="ai-badge ${confClass}">${(item.confidence * 100).toFixed(0)}%</span> ${item.category}</div>
                <div class="field-label">Êé®ÁêÜ‰æùÊçÆ</div><div class="reasoning-box">${item.reasoning}</div>
            `;
            document.getElementById('category-select').value = item.category;
            document.getElementById('review-actions').style.display = 'block';

            highlightItem(item.expressID);
        };

        function highlightItem(id) {
            ifcLoader.ifcManager.removeSubset(ifcModel.modelID, scene, highlightMaterial);
            const subset = ifcLoader.ifcManager.createSubset({
                modelID: ifcModel.modelID, ids: [id], material: highlightMaterial, scene: scene, removePrevious: true
            });
            if (subset.geometry) {
                subset.geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                subset.geometry.boundingBox.getCenter(center);
                controls.target.copy(center);
                const offset = new THREE.Vector3().subVectors(camera.position, controls.target).normalize().multiplyScalar(10);
                camera.position.copy(center).add(offset);
            }
        }

        window.confirmAndNext = function () {
            const item = reviewQueue[currentReviewIdx];
            item.category = document.getElementById('category-select').value;
            item.status = "MANUAL_FIXED";
            item.confidence = 1.0;

            const original = hitlData.results.find(r => r.guid === item.guid);
            if (original) { original.category = item.category; original.status = "MANUAL_FIXED"; }

            if (currentReviewIdx < reviewQueue.length - 1) {
                currentReviewIdx++;
                loadReviewItem(currentReviewIdx);
            } else {
                alert("Â§çÊ†∏ÂÆåÊàêÔºåËØ∑ÂØºÂá∫„ÄÇ");
            }
        };

        window.prevItem = function () {
            if (currentReviewIdx > 0) { currentReviewIdx--; loadReviewItem(currentReviewIdx); }
        };

        window.exportResults = function () {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(hitlData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", str);
            node.setAttribute("download", "reviewed_results.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        };

        function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>