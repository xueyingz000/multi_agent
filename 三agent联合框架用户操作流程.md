# 三Agent联合建筑面积计算Framework用户操作流程

## 系统架构概述

本framework由三个LLM agent协同工作：
1. **LLM Regulation Agent** - 法规分析agent
2. **Semantic Alignment Agent** - 语义对齐agent  
3. **Building Area Agent** - 建筑面积计算agent

## 用户操作流程

### 第一阶段：法规分析 (LLM Regulation Agent)

#### 用户操作：
1. **上传法规文件**
   - 用户通过界面上传建筑面积计算相关的法规文档（PDF格式）
   - 支持多个地区的法规文件（如中国大陆、香港、美国、欧盟等）
   - 界面显示：文件上传区域，支持拖拽上传

2. **选择分析参数**
   - 选择目标地区/法规类型
   - 设置分析精度等级
   - 界面显示：下拉菜单和参数配置面板

3. **启动法规分析**
   - 点击"开始分析"按钮
   - 界面显示：进度条和实时分析状态

#### 用户界面看到的信息：

**分析进度界面：**
```
正在分析法规文档...
[████████████████████████████████████████] 100%

当前处理：香港建筑面积计算规则
已提取规则：
- 层高相关规则：3条
- 覆盖/围护构件规则：8条  
- 特殊用途空间规则：5条
```

**分析结果展示：**
```json
{
  "per_region": {
    "HK": {
      "region": "HK",
      "source_name": "香港建筑面积计算规则",
      "height_rules": [
        {
          "label": "full",
          "comparator": ">=",
          "threshold_min_m": 2.2,
          "evidence": ["层高不少于2.2米的空间计入全部面积"]
        }
      ],
      "cover_enclosure_rules": [
        {
          "feature_key": "balcony",
          "label": "excluded",
          "evidence": ["无围护的露台不计入面积"]
        },
        {
          "feature_key": "lift",
          "label": "full", 
          "evidence": ["电梯井计入全部面积"]
        }
      ],
      "special_use_rules": [
        {
          "feature_key": "parking",
          "label": "excluded",
          "evidence": ["停车位不计入建筑面积"]
        }
      ]
    }
  }
}
```

### 第二阶段：语义对齐 (Semantic Alignment Agent)

#### 用户操作：
1. **上传IFC文件**
   - 用户上传建筑的IFC模型文件
   - 界面显示：文件信息预览（文件大小、元素数量等）

2. **配置对齐参数**
   - 选择建筑类型（住宅、商业、办公等）
   - 设置几何容差
   - 界面显示：参数配置面板

3. **启动语义对齐**
   - 系统自动读取第一阶段的法规分析结果
   - 点击"开始对齐分析"按钮

#### 用户界面看到的信息：

**对齐进度界面：**
```
正在进行语义对齐分析...
[████████████████████████████████████████] 100%

处理进度：
- IFC元素提取：150个元素 ✓
- 垂直空间检测：5个空间 ✓  
- A类功能语义对齐：120个元素 ✓
- B类几何-法规对齐：35个元素 ✓
- 置信度评估：完成 ✓
```

**对齐结果展示：**
```json
{
  "alignment_report": {
    "summary": {
      "total_elements": 155,
      "high_confidence_count": 130,
      "medium_confidence_count": 20,
      "low_confidence_count": 5,
      "requires_review_count": 5
    },
    "confidence_distribution": {
      "high": 0.84,
      "medium": 0.13,
      "low": 0.03
    },
    "regulation_categories": {
      "fully_included": 120,
      "partially_included": 25,
      "excluded": 10
    },
    "review_required": [
      {
        "element_guid": "3zXy_s_s_1A9_s_s_s_5",
        "reason": "低置信度分类",
        "confidence": 0.45
      }
    ]
  },
  "classification_summary": {
    "function_classifications": [
      {
        "element_guid": "3zXy_s_s_1A9_s_s_s_1",
        "ifc_type": "IfcSlab",
        "regulation_category": "楼板",
        "confidence": 0.95,
        "reasoning_path": "直接匹配"
      }
    ],
    "category_breakdown": {
      "A": 120,
      "B": 35
    }
  }
}
```

**需要人工审核的元素列表：**
```
需要人工审核的元素 (5个)：

1. 元素ID: 3zXy_s_s_1A9_s_s_s_5
   类型: IfcSpace
   建议分类: 半计入面积
   置信度: 45%
   原因: 空间用途不明确
   [审核] [接受建议] [重新分类]

2. 元素ID: 3zXy_s_s_1A9_s_s_s_8  
   类型: IfcCovering
   建议分类: 不计入面积
   置信度: 38%
   原因: 覆盖构件类型模糊
   [审核] [接受建议] [重新分类]
```

### 第三阶段：建筑面积计算 (Building Area Agent)

#### 用户操作：
1. **确认输入数据**
   - 系统自动加载前两个阶段的分析结果
   - 用户可以查看和确认输入数据的完整性
   - 对于需要审核的元素，用户可以进行最终确认

2. **启动面积计算**
   - 点击"开始计算建筑面积"按钮
   - 系统根据法规规则和语义对齐结果进行计算

#### 用户界面看到的信息：

**计算进度界面：**
```
正在计算建筑面积...
[████████████████████████████████████████] 100%

计算步骤：
- 楼层分类（按层高）：完成 ✓
- 全计入面积计算：1,250.5 m² ✓
- 半计入面积计算：180.2 m² ✓  
- 不计入面积统计：320.8 m² ✓
- 总建筑面积汇总：完成 ✓
```

**最终计算结果：**
```
=================== 建筑面积计算结果 ===================

总建筑面积：1,340.6 m²

详细分解：
┌─────────────────────┬──────────────┬──────────────┐
│ 计算类别            │ 面积 (m²)    │ 计算系数     │
├─────────────────────┼──────────────┼──────────────┤
│ 全计入面积          │ 1,250.5      │ 1.0          │
│ 半计入面积          │ 180.2        │ 0.5          │
│ 不计入面积          │ 320.8        │ 0.0          │
└─────────────────────┴──────────────┴──────────────┘

按楼层统计：
• 1层：层高2.8m - 全计入面积：420.3 m²
• 2层：层高2.8m - 全计入面积：415.1 m²  
• 3层：层高2.8m - 全计入面积：415.1 m²
• 地下室：层高2.1m - 不计入面积：320.8 m²
• 阳台：半计入面积：180.2 m²

按构件类型统计：
• 楼板：1,250.5 m²
• 阳台：90.1 m² (半计入)
• 雨篷：90.1 m² (半计入)
• 停车位：320.8 m² (不计入)

质量检查：
✓ 所有元素已分类
✓ 计算规则一致性检查通过
✓ 面积计算精度：±0.1 m²

[导出报告] [保存结果] [重新计算]
```

## 用户界面总体设计

### 主界面布局
```
┌─────────────────────────────────────────────────────────────┐
│ 建筑面积计算Framework v1.0                    [设置] [帮助] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐                │
│  │ 第一步  │───▶│ 第二步  │───▶│ 第三步  │                │
│  │法规分析 │    │语义对齐 │    │面积计算 │                │
│  │  ✓     │    │  ✓     │    │   ●    │                │
│  └─────────┘    └─────────┘    └─────────┘                │
│                                                             │
│  当前阶段：建筑面积计算                                     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   结果展示区域                      │   │
│  │                                                     │   │
│  │  [计算结果、图表、详细信息等]                       │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  导出报告   │ │  保存项目   │ │  新建项目   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 关键用户体验特性

1. **进度可视化**：每个阶段都有清晰的进度指示
2. **结果可审核**：对于低置信度的分类结果，提供人工审核机制
3. **数据可追溯**：每个计算结果都可以追溯到具体的法规条款和IFC元素
4. **报告可导出**：支持PDF、Excel等格式的详细报告导出
5. **错误处理**：对于异常情况提供清晰的错误信息和解决建议

## 数据流转图

```
法规PDF文件 ──┐
             ├─▶ LLM Regulation Agent ──┐
地区选择 ────┘                          │
                                        ▼
                                   regulation.json
                                        │
IFC模型文件 ──┐                         │
             ├─▶ Semantic Alignment ◀───┘
对齐参数 ────┘         Agent
                        │
                        ▼
                 alignment_report.json
                 classification_summary.json
                        │
                        ▼
                Building Area Agent
                        │
                        ▼
                  最终面积计算结果
```

这个framework为用户提供了一个完整的、自动化的建筑面积计算解决方案，通过三个专业化的AI agent协同工作，大大提高了计算的准确性和效率。