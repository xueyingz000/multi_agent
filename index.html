<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IFC Viewer - äº¤äº’ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }

        #three-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        /* å·¦ä¸Šè§’æ§åˆ¶åŒº */
        #controls-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15);
            z-index: 1;
            width: 280px;
        }

        /* å³ä¾§å±æ€§é¢æ¿ (é»˜è®¤éšè—) */
        #property-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1;
            display: none;
            /* åˆå§‹éšè— */
            flex-direction: column;
            overflow: hidden;
        }

        #property-header {
            padding: 15px;
            background: #0078d4;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #property-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
            font-size: 13px;
        }

        /* å±æ€§è¡¨æ ¼æ ·å¼ */
        .prop-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .prop-table td {
            padding: 6px;
            border-bottom: 1px solid #eee;
            word-break: break-word;
        }

        .prop-key {
            font-weight: bold;
            color: #555;
            width: 40%;
        }

        .prop-val {
            color: #333;
        }

        .group-title {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #0078d4;
            border-bottom: 2px solid #eee;
            padding-bottom: 3px;
        }

        /* å…¶ä»– UI å…ƒç´  */
        h1 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #333;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .tips {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
            flex-direction: column;
            color: #333;
            font-weight: bold;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        button.close-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
    </style>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
                "three/examples/jsm/": "https://unpkg.com/three@0.155.0/examples/jsm/",
                "web-ifc-three": "https://unpkg.com/web-ifc-three@0.0.126/IFCLoader.js",
                "web-ifc": "https://unpkg.com/web-ifc@0.0.44/web-ifc-api.js" 
            }
        }
    </script>
</head>

<body>

    <div id="controls-container">
        <h1>ğŸ—ï¸ Web IFC æŸ¥çœ‹å™¨</h1>
        <input type="file" id="file-input" accept=".ifc">
        <div class="tips">
            <strong>æ“ä½œæŒ‡å—:</strong><br>
            ğŸ–±ï¸ å·¦é”®æ‹–æ‹½: æ—‹è½¬<br>
            ğŸ–±ï¸ å³é”®æ‹–æ‹½: å¹³ç§»<br>
            ğŸ–±ï¸ æ»šè½®: ç¼©æ”¾<br>
            ğŸ‘† <strong>åŒå‡»æ„ä»¶:</strong> æŸ¥çœ‹å±æ€§ & é«˜äº®<br>
            âŒ¨ï¸ Escape: å–æ¶ˆé€‰æ‹©
        </div>
    </div>

    <div id="property-panel">
        <div id="property-header">
            <span>æ„ä»¶å±æ€§</span>
            <button class="close-btn"
                onclick="document.getElementById('property-panel').style.display='none'">âœ•</button>
        </div>
        <div id="property-content">ç‚¹å‡»æ„ä»¶æŸ¥çœ‹è¯¦æƒ…...</div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>æ­£åœ¨è§£æ IFC æ¨¡å‹...</div>
    </div>

    <canvas id="three-canvas"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { IFCLoader } from 'web-ifc-three';

        // --- 1. åŸºç¡€åœºæ™¯åˆå§‹åŒ– ---
        const canvas = document.getElementById('three-canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe8e8e8);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(15, 15, 15);

        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);
        const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.4); // è¡¥å…‰
        dirLight2.position.set(-10, -10, -5);
        scene.add(dirLight2);

        // è¾…åŠ©ç½‘æ ¼
        const gridHelper = new THREE.GridHelper(100, 100, 0x888888, 0xbbbbbb);
        scene.add(gridHelper);
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);

        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;

        // --- 2. IFC åŠ è½½å™¨é…ç½® ---
        const ifcLoader = new IFCLoader();
        // å¿…é¡»æŒ‡å‘æ­£ç¡®çš„ wasm è·¯å¾„
        ifcLoader.ifcManager.setWasmPath('https://unpkg.com/web-ifc@0.0.44/');

        // é…ç½®é«˜äº®æè´¨ (åŠé€æ˜é»„è‰²)
        const highlightMaterial = new THREE.MeshLambertMaterial({
            transparent: true,
            opacity: 0.6,
            color: 0xffcc00,
            depthTest: false // ç¡®ä¿é«˜äº®å§‹ç»ˆæ˜¾ç¤ºåœ¨æœ€å‰é¢
        });

        let ifcModel = null;

        // --- 3. äº¤äº’æ ¸å¿ƒé€»è¾‘ (Raycasting) ---
        const raycaster = new THREE.Raycaster();
        raycaster.firstHitOnly = true; // æ€§èƒ½ä¼˜åŒ–ï¼šåªæ£€æµ‹ç¬¬ä¸€ä¸ªç¢°æ’ç‚¹
        const mouse = new THREE.Vector2();

        function cast(event) {
            // è®¡ç®—é¼ æ ‡åœ¨å±å¹•ä¸Šçš„å½’ä¸€åŒ–åæ ‡ (-1 åˆ° +1)
            const bounds = canvas.getBoundingClientRect();
            const x1 = event.clientX - bounds.left;
            const y1 = event.clientY - bounds.top;
            mouse.x = (x1 / bounds.width) * 2 - 1;
            mouse.y = -(y1 / bounds.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // æ£€æµ‹å°„çº¿ä¸æ¨¡å‹çš„ç¢°æ’
            return raycaster.intersectObjects([ifcModel]);
        }

        // åŒå‡»äº‹ä»¶å¤„ç†
        window.ondblclick = async (event) => {
            if (!ifcModel) return;

            const found = cast(event)[0];
            if (found) {
                // 1. è·å–é€‰ä¸­æ„ä»¶çš„ expressID (IFC ä¸­çš„å”¯ä¸€ ID)
                const index = found.faceIndex;
                const geometry = found.object.geometry;
                const id = ifcLoader.ifcManager.getExpressId(geometry, index);

                // 2. é«˜äº®æ„ä»¶
                // createSubset æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æŒ‡å®š ID çš„æ–° Mesh
                // removePrevious: true ä¼šè‡ªåŠ¨æ¸…é™¤ä¸Šä¸€æ¬¡çš„é«˜äº®
                ifcLoader.ifcManager.createSubset({
                    modelID: ifcModel.modelID,
                    ids: [id],
                    material: highlightMaterial,
                    scene: scene,
                    removePrevious: true
                });

                // 3. è·å–å¹¶æ˜¾ç¤ºå±æ€§
                displayProperties(id);
            } else {
                // ç‚¹å‡»ç©ºç™½å¤„ï¼Œæ¸…é™¤é«˜äº®
                ifcLoader.ifcManager.removeSubset(ifcModel.modelID, scene, highlightMaterial);
                document.getElementById('property-panel').style.display = 'none';
            }
        };

        // æŒ‰ ESC æ¸…é™¤é€‰æ‹©
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && ifcModel) {
                ifcLoader.ifcManager.removeSubset(ifcModel.modelID, scene, highlightMaterial);
                document.getElementById('property-panel').style.display = 'none';
            }
        });

        // --- 4. å±æ€§è§£æé€»è¾‘ ---
        async function displayProperties(id) {
            const propPanel = document.getElementById('property-panel');
            const propContent = document.getElementById('property-content');

            propPanel.style.display = 'flex';
            propContent.innerHTML = 'Loading properties...';

            try {
                const modelID = ifcModel.modelID;

                // è·å–åŸºæœ¬å±æ€§ (Name, GlobalId, Tag ç­‰)
                const props = await ifcLoader.ifcManager.getItemProperties(modelID, id);

                // è·å–å±æ€§é›† (Property Sets - Pset_WallCommon ç­‰ï¼ŒåŒ…å«å°ºå¯¸ä¿¡æ¯)
                const psets = await ifcLoader.ifcManager.getPropertySets(modelID, id);

                let html = `<div class="group-title">åŸºæœ¬ä¿¡æ¯ (Basic)</div>`;
                html += `<table class="prop-table">`;
                html += `<tr><td class="prop-key">Entity</td><td class="prop-val">${props.expressID}</td></tr>`;
                html += `<tr><td class="prop-key">Name</td><td class="prop-val">${props.Name ? props.Name.value : '-'}</td></tr>`;
                html += `<tr><td class="prop-key">Type</td><td class="prop-val">${formatIFCType(props.constructor.name)}</td></tr>`;
                html += `<tr><td class="prop-key">GlobalId</td><td class="prop-val">${props.GlobalId ? props.GlobalId.value : '-'}</td></tr>`;
                html += `</table>`;

                // éå†å±æ€§é›† (Pset)
                for (const pset of psets) {
                    // è¿™é‡Œåšä¸€äº›ç®€å•çš„è¿‡æ»¤ï¼Œåªæ˜¾ç¤ºå±æ€§é›†
                    if (pset.HasProperties) {
                        html += `<div class="group-title">${pset.Name ? pset.Name.value : 'PSet'}</div>`;
                        html += `<table class="prop-table">`;

                        for (const propRef of pset.HasProperties) {
                            // è¿™é‡Œéœ€è¦å†æ¬¡å¼‚æ­¥è·å–å…·ä½“æ¯æ¡å±æ€§çš„å€¼ï¼Œå› ä¸º IFC æ˜¯å¼•ç”¨çš„
                            const prop = await ifcLoader.ifcManager.getItemProperties(modelID, propRef.value);
                            const key = prop.Name ? prop.Name.value : 'Unknown';
                            let val = '-';

                            if (prop.NominalValue) {
                                val = prop.NominalValue.value;
                                // ç®€å•çš„æ•°å€¼å¤„ç† (ä¾‹å¦‚ä¿ç•™3ä½å°æ•°)
                                if (typeof val === 'number') val = val.toFixed(3);
                            }

                            html += `<tr><td class="prop-key">${key}</td><td class="prop-val">${val}</td></tr>`;
                        }
                        html += `</table>`;
                    }
                }

                propContent.innerHTML = html;

            } catch (error) {
                console.error(error);
                propContent.innerHTML = "æ— æ³•è¯»å–å±æ€§æ•°æ®";
            }
        }

        function formatIFCType(typeStr) {
            // ç®€å•ç¾åŒ– IFC ç±»å‹åç§°ï¼Œä¾‹å¦‚ IfcWallStandardCase -> Wall Standard Case
            return typeStr.replace('Ifc', '').replace(/([A-Z])/g, ' $1').trim();
        }

        // --- 5. æ–‡ä»¶åŠ è½½é€»è¾‘ ---
        const input = document.getElementById('file-input');
        const overlay = document.getElementById('loading-overlay');

        input.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            overlay.style.display = 'flex';

            // æ¸…ç†æ—§æ¨¡å‹
            if (ifcModel) {
                scene.remove(ifcModel);
                ifcLoader.ifcManager.removeSubset(ifcModel.modelID, scene, highlightMaterial);
                ifcModel = null;
            }

            const ifcURL = URL.createObjectURL(file);
            ifcLoader.load(ifcURL, (model) => {
                ifcModel = model;
                scene.add(model);
                overlay.style.display = 'none';

                // è‡ªåŠ¨å¯¹ç„¦
                if (model.geometry.boundingBox) {
                    const center = new THREE.Vector3();
                    model.geometry.boundingBox.getCenter(center);
                    controls.target.copy(center);
                    camera.position.set(center.x + 10, center.y + 10, center.z + 10);
                }
            });
        });

        // æ¸²æŸ“å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // çª—å£è‡ªé€‚åº”
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>

</html>