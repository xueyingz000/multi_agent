┌─────────────────────────┐
│        IFC 模型         │
└─────────────┬───────────┘
              │
              ▼
┌─────────────────────────┐
│  RegulationParser       │  解析法规 JSON
│ → regulation_data       │
└─────────────┬───────────┘
              │
              ▼
┌─────────────────────────┐
│     IfcExtractor        │  提取 IFC 元素与属性
│ → List[IfcElementInfo]  │
└─────────────┬───────────┘
              │
              ▼
┌─────────────────────────┐
│   GeometryAnalyzer      │  计算几何特征
│ → GeometricFeatures     │
└─────────────┬───────────┘
              │
              ├─────────────────────────────────────────────────────────────────────┐
              │                                                                     │
              ▼                                                                     ▼
┌──────────────────────────────────────┐                          ┌────────────────────────────────────────┐
│      FunctionInferenceEngine         │                          │        VerticalSpaceDetector           │
│                                      │                          │                                        │
│  1) 规则匹配:                         │                          │  1) 多实体扫描:                         │
│     _find_matching_rules             │                          │     - 直接 `IfcSpace`                  │
│     - 遍历 `InferenceRule`           │                          │     - 显式 `IfcOpeningElement`         │
│     - 乘法式软约束 `match_score`     │                          │       (水平对齐 + 连续性追踪)          │
│     - `base_conf = conf_base×score`  │                          │     - 隐式 void (网格聚类 + 跨层 IoU)   │
│                                      │                          │     - 边界不连续 (墙/板边界缺失)        │
│  2) 置信度调整:                       │                          │                                        │
│     _adjust_confidence               │                          │  2) 连续性验证与评分:                   │
│     + 几何一致性 ×0.20               │                          │     _validate_geometric_continuity     │
│     + 关键词匹配 ×0.15               │                          │     - 垂直对齐                         │
│     + 上下文匹配 ×0.10               │                          │     - 跨层跨度                         │
│     + 属性证据 ×0.15                 │                          │     - 几何完整性                       │
│     → 裁剪到 [0.10, 0.95]            │                          │     → 候选 `confidence`                │
│                                      │                          │                                        │
│  3) 可解释性输出:                     │                          │  3) 合并与去重:                         │
│     - _collect_evidence              │                          │     _consolidate_and_deduplicate       │
│     - _generate_alternatives         │                          │     - 2D IoU 分组与合并                │
│     - _generate_reasoning_path       │                          │     - 保留最高置信来源                  │
│                                      │                          │     - 组合元素/包围盒                  │
│  4) LLM 增强(可选):                   │                          │                                        │
│     - _needs_llm_analysis            │                          │  4) 分类与完成:                         │
│     - _llm_enhanced_inference        │                          │     _classify_and_finalize             │
│     - _combine_llm_and_rule_results  │                          │     - 类型判别(中庭/竖井/楼梯/电梯等)   │
│     → 若 LLM 置信度更高则替换        │                          │     - 计算面积影响/证据收集             │
└──────────────────────────────────────┘                          └────────────────────────────────────────┘
              │                                                                     │
              ▼                                                                     ▼
┌──────────────────────────────────────┐                          ┌────────────────────────────────────────┐
│  FunctionInference (per element)     │                          │  VerticalSpaceInfo (per vertical void)│
│  - primary_function                  │                          │  - space_type                          │
│  - confidence                        │                          │  - confidence                          │
│  - evidence/alternatives/reasoning   │                          │  - evidence/geometry/context           │
└─────────────┬────────────────────────┘                          └─────────────┬───────────────────────────┘
              │                                                                     │
              └───────────────────────────┬──────────────────────────────────────────┘
                                          ▼
                      ┌───────────────────────────────────────────────────────────────────────────────┐
                      │ SemanticAlignmentAgent                                                        │
                      │                                                                               │
                      │ A1 Component Function Classification (e.g., Slab)                             │
                      │  - Aggregate FunctionInference evidence                                       │
                      │  - Geometry/attribute consistency checks                                      │
                      │  - Confidence clipping and conflict resolution                                │
                      │  → A1Result                                                                   │
                      │                                                                               │
                      │ A2 Space Function Classification                                              │
                      │  - Evidence fusion: function inference + geometric cues                       │
                      │    (e.g., floor_height < 2.2m) + building-type context                        │
                      │  - Ambiguity handling: conservative alternatives at low confidence            │
                      │    (unclassified/auxiliary rooms)                                            │
                      │  - LLM enhancement: infer_function_enhanced()                                 │
                      │    (triggered by low confidence/many candidates/sparse evidence)              │
                      │  - Result merge: replace if LLM more credible; else small boost with          │
                      │    explainability                                                             │
                      │  → A2Result                                                                   │
                      │                                                                               │
                      │ B Vertical Space Detection Integration                                        │
                      │  - Continuity and inter-floor span consistency checks                          │
                      │  - Candidate consolidation and deduplication                                  │
                      │  → BResult                                                                    │
                      └─────────────┬─────────────────────────────────────────────────────────────────┘
                                    ▼
                      ┌───────────────────────────────────────────────────────────────────────────────┐
                      │        HITL Gate: 置信度/冲突检查 (人机协作管理器)                            │
                      │  条件:                                                                        │
                      │   - confidence < τ_low  或                                                     │
                      │   - 候选过多/规则冲突/证据稀疏                                                │
                      └─────────────┬───────────────────────────────────────────────┬────────────────┘
                                    │                                               │
                                    │(高置信/无冲突)                                │(低置信/有冲突)
                                    ▼                                               ▼
                     ┌─────────────────────────┐                     ┌───────────────────────────────────┐
                     │ Auto Finalize Path      │                     │ Human Collaboration Panel         │
                     │ - A1/A2/B 合并与确认   │                     │ 微任务:                           │
                     │ - 置信度维持            │                     │  - 勾选类别/功能                   │
                     │ → FinalResults          │                     │  - 确认/否决候选                   │
                     └─────────────┬───────────┘                     │  - 纠正几何边界(选区/框选)         │
                                   │                                  │  - 标注参考证据(属性/几何)         │
                                   │                                  └─────────────┬───────────────────┘
                                   ▼                                                ▼
                     ┌─────────────────────────┐                     ┌───────────────────────────────────┐
                     │ Reporting & Summary     │                     │ Decision Integrator & Confidence  │
                     │ alignment_report        │                     │ Boost                             │
                     │ classification_summary  │                     │ - 合并人类输入与自动结果            │
                     └─────────────────────────┘                     │ - 重新计分与解释更新               │
                                                                      │ → FinalResults(提升至≈0.95)       │
                                                                      └─────────────┬───────────────────┘
                                                                                    │
                                                                                    ▼
                                                                      ┌─────────────────────────┐
                                                                      │ Reporting & Summary     │
                                                                      │ alignment_report        │
                                                                      │ classification_summary  │
                                                                      └─────────────────────────┘

                                    ┌────────────────────────────────────────────────────────────────┐
                                    │    Feedback Store & Active Learning                            │
                                    │  - 记录人类操作与判定                                           │
                                    │  - 形成训练样本/阈值调校数据                                     │
                                    │  - 闭环更新: 规则/LLM/评分策略                                  │
                                    └────────────────────────────────────────────────────────────────┘

                                    ┌────────────────────────────────────────────────────────────────┐
                                    │    Policy & Metrics Monitor                                    │
                                    │  - τ_low/τ_mid/τ_high 配置与AB实验                              │
                                    │  - 命中率/覆盖率/人工介入率/平均耗时                             │
                                    │  - 质量门槛与批量分流(优先级队列/聚类打包)                       │
                                    └────────────────────────────────────────────────────────────────┘